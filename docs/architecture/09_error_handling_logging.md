# 错误处理与日志记录 (Error Handling & Logging)

健壮的错误处理和清晰的日志记录对于 Datapresso 框架的稳定性、可维护性和用户调试至关重要。本文档详细说明了框架在这方面的设计原则和实现策略。

## 日志记录 (Logging)

框架使用 Python 内置的 `logging` 模块，并通过 `datapresso.utils.logging_utils` (或类似模块) 进行统一配置和管理。

### 日志级别

标准日志级别用于区分信息的重要性：

*   **DEBUG**: 最详细的日志，用于开发者调试，例如追踪函数调用、变量值等。默认在生产环境中关闭。
*   **INFO**: 提供流程性的信息，例如 Pipeline 阶段的开始和结束、处理的数据量、关键配置信息等。这是默认的日志级别。
*   **WARNING**: 表示可能出现的问题或非严重错误，例如某个配置项使用了默认值、某个可选依赖缺失但不影响核心功能等。程序会继续运行。
*   **ERROR**: 表示发生了严重错误，导致某个任务或阶段无法完成，例如 LLM API 调用失败、关键文件找不到、数据格式错误等。通常会导致程序部分或全部终止。
*   **CRITICAL**: 表示非常严重的错误，可能导致整个应用程序崩溃。

日志级别可以通过配置文件进行设置，允许用户根据需要调整日志的详细程度。

### 日志格式

日志记录应包含标准信息，以便于分析：

*   时间戳 (Timestamp)
*   日志级别 (Level)
*   模块/函数名 (Module/Function)
*   日志消息 (Message)

示例格式: `[YYYY-MM-DD HH:MM:SS,ms] [LEVEL] [module:lineno] - message`

### 日志输出

日志可以同时输出到：

*   **控制台 (Console)**: 方便用户实时查看 Pipeline 运行状态。
*   **日志文件 (File)**: 将所有日志（通常包括 DEBUG 级别）保存到 `logs/` 目录下，文件名可以包含时间戳或运行 ID，便于长期追踪和问题排查。

## 错误处理 (Error Handling)

框架采用分层和分类的错误处理策略。

### 错误类型

*   **配置错误 (Configuration Errors)**: 在 Pipeline 初始化阶段，通过 `ConfigValidator` 检测到无效或缺失的配置项。这类错误通常是致命的，会导致 Pipeline 启动失败并立即退出，同时打印清晰的错误信息指示哪个配置项有问题。
*   **环境错误 (Environment Errors)**: 如 Python 版本不兼容、缺少必要的依赖库、文件系统权限不足等。这些错误通常在程序启动或特定模块加载时发生，也应尽早抛出并终止。
*   **数据错误 (Data Errors)**: 如种子数据格式不正确、生成的数据无法解析等。处理策略可能取决于错误发生的阶段和严重性。
    *   **单条数据错误**: 在数据生成、评估或过滤阶段，如果处理单条数据时出错（例如某个评估模型无法处理特定输入），可以选择记录错误并跳过该条数据，继续处理剩余部分（可通过配置控制）。
    *   **批量数据错误**: 如果整个数据文件无法读取或格式严重错误，通常应视为严重错误并终止当前阶段。
*   **API/外部服务错误 (API/External Service Errors)**: 如调用 LLM API 时网络超时、认证失败、达到速率限制等。
    *   **可重试错误**: 对于临时性错误（如超时、速率限制），框架应实现自动重试机制（例如使用指数退避策略），并在多次重试失败后才报告为严重错误。
    *   **不可重试错误**: 对于认证失败、无效请求等错误，应立即报告为严重错误。
*   **内部逻辑错误 (Internal Logic Errors)**: 代码中的 Bug 或未预料到的状态。应尽可能通过断言、类型检查和单元测试来捕捉。如果发生，通常记录为 ERROR 或 CRITICAL。

### 处理策略

*   **快速失败 (Fail Fast)**: 对于配置错误、环境错误和关键阶段的严重错误（如无法加载核心模型、无法读取主要输入数据），采用快速失败策略，立即终止 Pipeline 并报告错误。这可以避免在错误状态下继续浪费计算资源或产生无效结果。
*   **容错处理 (Fault Tolerance)**: 对于处理单条数据时的可恢复错误或非核心功能的失败，可以选择记录错误并继续执行（例如，跳过出错的数据点）。这种行为应可通过配置项控制 (`pipeline.fail_on_single_error: true/false`)。
*   **明确的异常类型**: 使用自定义的异常类（例如 `DatapressoConfigError`, `DatapressoApiError`, `DatapressoDataError`）来区分不同类型的错误，便于上层代码捕获和处理。
*   **清晰的错误信息**: 抛出异常或记录错误时，提供尽可能详细和有用的上下文信息，包括错误发生的位置、涉及的数据、可能的原因以及建议的解决方法。

### 退出码 (Exit Codes)

Pipeline 运行结束后，应返回明确的退出码给调用环境（如 Shell 脚本）：

*   **0**: 成功完成。
*   **非 0**: 发生错误。可以使用不同的非零值来区分不同类型的错误（例如 1 表示配置错误，2 表示数据错误，3 表示 API 错误等）。

## 最佳实践

*   在每个主要模块和函数入口处添加适当的日志记录（至少 INFO 级别）。
*   对所有外部交互（文件 I/O, API 调用）使用 `try...except` 块，并捕获预期的异常。
*   避免捕获泛泛的 `Exception`，除非确实需要并能妥善处理。
*   提供配置选项来控制错误处理行为（如是否跳过单条错误）和日志级别。
*   编写单元测试来验证错误处理逻辑。